# Fizbane's Forge â€“ AI Guidance

- **Purpose:** Electron desktop D&D character creator. Main process owns window lifecycle + IPC; renderer is a single-page app loading dynamic pages/assets from the data directory.
- **Entry points:** Main process in [src/electron/main.js](../src/electron/main.js) wires IPC handlers and creates the BrowserWindow with contextIsolation+sandbox. Preload in [src/electron/preload.cjs](../src/electron/preload.cjs) exposes whitelisted IPC helpers under `window.app`, `window.data`, and `window.characterStorage` only.
- **IPC surfaces:** Channels are enumerated in [src/electron/ipc/channels.js](../src/electron/ipc/channels.js); use them instead of ad-hoc strings. Character CRUD/UUID go through [src/electron/ipc/handlers/CharacterHandlers.js](../src/electron/ipc/handlers/CharacterHandlers.js). File picker/open/read/write lives in [src/electron/ipc/handlers/FileHandlers.js](../src/electron/ipc/handlers/FileHandlers.js). Settings (`get/set/all`, app/userData paths) live in [src/electron/ipc/handlers/SettingsHandlers.js](../src/electron/ipc/handlers/SettingsHandlers.js).
- **Data sources:** Game data must come from a user-configured folder or downloaded cache. Validation/manifest building/downloading resides in [src/electron/DataFolderManager.js](../src/electron/DataFolderManager.js) and is orchestrated by [src/electron/ipc/handlers/DataHandlers.js](../src/electron/ipc/handlers/DataHandlers.js). `FF_DEBUG=true` forces the bundled `src/data` without persisting prefs (used by tests/debug). Remote URLs are normalized to raw GitHub for `/data` and are cached under userData.
- **Preferences:** Stored at `userData/preferences.json` via [src/electron/PreferencesManager.js](../src/electron/PreferencesManager.js); includes `characterSavePath`, data source config, theme/logLevel, window bounds. Window bounds are persisted on close from [src/electron/WindowManager.js](../src/electron/WindowManager.js).
- **Renderer startup:** [src/renderer/scripts/core/AppInitializer.js](../src/renderer/scripts/core/AppInitializer.js) orchestrates startup: ensures data source, initializes text processor, page handler, navigation, settings service, then loads all data services in parallel (spells/items/classes/races/etc). Unsaved-change indicator is driven by EventBus events.
- **Event bus:** Central events live in [src/renderer/scripts/utils/EventBus.js](../src/renderer/scripts/utils/EventBus.js); prefer emitting/listening there instead of custom DOM events. Services typically emit `SERVICE_INITIALIZED` on init.
- **Data loading pattern:** Use [src/renderer/scripts/utils/DataLoader.js](../src/renderer/scripts/utils/DataLoader.js); it caches requests and first tries IPC `window.data.loadJSON`. Avoid direct `fetch`/`fs` calls from the renderer.
- **Character storage:** Renderer wrapper in [src/renderer/scripts/core/Storage.js](../src/renderer/scripts/core/Storage.js) talks to preload IPC; saves `.ffp` files under the configured save path. Use `storage.getCharacter(s)/saveCharacter/deleteCharacter/import/export/generateUUID` instead of custom IPC.
- **Services:** Feature data services (e.g., races, classes, feats, items) live in [src/renderer/scripts/services](../src/renderer/scripts/services) and expose `initialize()` that preloads JSON via `DataLoader`. Follow this pattern for new data domains.
- **UI/navigation:** DOM shell is [src/renderer/index.html](../src/renderer/index.html); navigation buttons use `data-page` and are routed by `NavigationController`/`PageHandler` in `core/`. Floating save bar uses AppState + EventBus to show unsaved status only on build/details pages.
- **Text/tooltip rendering:** Inline 5etools tags are parsed by [src/renderer/scripts/utils/TagProcessor.js](../src/renderer/scripts/utils/TagProcessor.js) with registered handlers for race/class/feat/spell/etc; extend via `registerHandler`. Race/subrace derivation helpers live in [src/renderer/scripts/utils/RaceDataUtils.js](../src/renderer/scripts/utils/RaceDataUtils.js).
- **Testing:** Playwright specs in [tests](../tests) launch Electron via `_electron`. Set env `FF_DEBUG=true FF_ALLOW_DEFAULT_DATA=true` (matches `npm run debug`) so tests use bundled data and skip config modals. Use `npx playwright test` from repo root; headless is on by default in [playwright.config.js](../playwright.config.js).
- **Tooling:** `npm start` runs Electron; `npm run debug` enables debug mode + default data; `npm run check:lint` / `check:format` (Biome) for CI-style checks; `npm run format`/`lint` to auto-fix. Packaging via `npm run pack` (dir) or `npm run dist` (installers).
- **Data contracts:** Required data set includes files like `races.json`, `backgrounds.json`, `feats.json`, `items.json`, plus class/spell indexes; DataFolderManager will fail validation if missing. Keep JSON shape aligned with 5etools expectations (e.g., `race` array in `races.json`).
- **Adding data-dependent features:** Validate availability through `DataLoader` and surface errors via Notifications. Respect `AppState.hasUnsavedChanges` and emit `EVENTS.CHARACTER_UPDATED` when mutating the active character so the save indicator stays accurate.
- **Security:** Renderer runs with `contextIsolation` + `sandbox`; only expose new capabilities through preload (update both preload and IPC channels) and keep CSP in [src/renderer/index.html](../src/renderer/index.html) in mind.
- **When in doubt:** Follow existing service + EventBus patterns, and prefer using the preload-exposed APIs instead of adding new direct Electron imports in the renderer.
