<!DOCTYPE HTML>
<html>

<head>
    <title>D&D Character Creator</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: blob:;
        font-src 'self';
        connect-src 'self';
        worker-src 'self';
        manifest-src 'self'
    " />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/tooltip.css" />
</head>

<body>
    <div class="app-container">
        <!-- Notification Container -->
        <div id="notificationContainer" class="notification-container"></div>

        <!-- Tooltip Container -->
        <div id="tooltipContainer" class="tooltip-container"></div>

        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="h4 mb-0">D&D Character Creator</h1>
            </div>
            <ul class="sidebar-nav">
                <li class="nav-item">
                    <button class="nav-link active" data-page="home">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-page="build">
                        <i class="fas fa-hammer"></i>
                        <span>Character Build</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-page="equipment">
                        <i class="fas fa-shield-alt"></i>
                        <span>Equipment</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-page="details">
                        <i class="fas fa-user"></i>
                        <span>Details</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-page="tooltipTest">
                        <i class="fas fa-comment-alt"></i>
                        <span>Tooltip Test</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </button>
                </li>
            </ul>
            <div class="sidebar-sources">
                <h6>Allowed Sources:</h6>
                <div class="source-list" id="sidebarSourceList">
                    <!-- Source toggles will be dynamically added here -->
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Page Content -->
                <div id="pageContent">
                    <!-- Content will be dynamically loaded here -->
                </div>
            </div>
            <!-- Floating Action Buttons -->
            <div class="floating-actions" id="characterActions">
                <div class="d-flex align-items-center">
                    <span id="unsavedChangesIndicator" class="text-warning me-2" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i> Unsaved changes
                    </span>
                    <button class="btn btn-primary me-2" id="saveCharacter">
                        <i class="fas fa-save"></i>
                        <span>Save</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Page Templates -->
    <template id="homePage">
        <div class="row mb-4">
            <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary" id="newCharacterBtn">
                    <i class="fas fa-plus"></i> New Character
                </button>
                <button class="btn btn-secondary" id="importCharacterBtn">
                    <i class="fas fa-file-import"></i> Import Character
                </button>
            </div>
        </div>
        <div class="row" id="characterList">
            <!-- Character cards will be dynamically inserted here -->
        </div>
    </template>

    <template id="buildPage">
        <div class="row">
            <!-- Race Selection -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Race</h5>
                    </div>
                    <div class="card-body race-card-body">
                        <div class="mb-3">
                            <div class="race-selection-controls">
                                <div class="race-selectors">
                                    <div class="race-select-container">
                                        <select class="form-select" id="raceSelect">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="race-select-container">
                                        <select class="form-select" id="subraceSelect" disabled>
                                            <option value="">Select Race First</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="race-content-container">
                                    <div class="race-quick-desc" id="raceQuickDesc">
                                        <!-- Quick description will be added here -->
                                    </div>
                                </div>
                            </div>
                            <div class="race-image-container">
                                <div class="race-image" id="raceImage">
                                    <!-- Race image will be set dynamically -->
                                    <i class="fas fa-user-circle placeholder-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="race-content-container">
                            <div id="raceDetails"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Class Selection -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Class</h5>
                    </div>
                    <div class="card-body class-card-body">
                        <div class="mb-3">
                            <div class="class-selection-controls">
                                <div class="class-selectors">
                                    <div class="class-select-container">
                                        <select class="form-select" id="classSelect">
                                            <!-- Options will be populated dynamically -->
                                        </select>
                                    </div>
                                    <div class="class-select-container">
                                        <select class="form-select" id="subclassSelect" disabled>
                                            <option value="">Select Class First</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="class-content-container">
                                    <div class="class-quick-desc" id="classQuickDesc">
                                        <!-- Quick description will be added here -->
                                    </div>
                                </div>
                            </div>
                            <div class="class-image-container">
                                <div class="class-image" id="classImage">
                                    <!-- Class image will be set dynamically -->
                                    <i class="fas fa-user-circle placeholder-icon"></i>
                                </div>
                            </div>
                        </div>
                        <div class="class-content-container">
                            <div id="classDetails"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Background -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Background</h5>
                    </div>
                    <div class="card-body background-card-body">
                        <div class="mb-3">
                            <div class="background-selection-controls">
                                <div class="background-selectors">
                                    <div class="background-select-container">
                                        <select class="form-select" id="backgroundSelect">
                                            <option value="">Choose a background...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="background-content-container">
                            <div id="backgroundDetails">
                                <!-- Background details will be rendered by EntityCard -->
                            </div>
                            <div id="backgroundCharacteristics">
                                <!-- Characteristics will be rendered by CharacteristicManager -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ability Scores -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Ability Scores</h5>
                    </div>
                    <div class="card-body">
                        <div class="ability-score-container">
                            <!-- Ability scores will be populated dynamically -->
                        </div>
                        <div class="ability-bonuses-container mt-3" id="abilityBonusesNotes">
                            <!-- Ability score bonuses notes will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Proficiencies -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Proficiencies</h5>
                    </div>
                    <div class="card-body">
                        <div class="proficiency-container">
                            <!-- Skills -->
                            <div class="proficiency-section mb-4">
                                <h6>Skills</h6>
                                <div id="skillsContainer" class="proficiency-grid">
                                    <!-- Skills will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Saving Throws -->
                            <div class="proficiency-section mb-4">
                                <h6>Saving Throws</h6>
                                <div id="savingThrowsContainer" class="proficiency-grid">
                                    <!-- Saving throws will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Languages -->
                            <div class="proficiency-section mb-4">
                                <h6>Languages</h6>
                                <div id="languagesContainer" class="proficiency-grid">
                                    <!-- Languages will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Tools -->
                            <div class="proficiency-section mb-4">
                                <h6>Tools</h6>
                                <div id="toolsContainer" class="proficiency-grid">
                                    <!-- Tools will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Armor -->
                            <div class="proficiency-section mb-4">
                                <h6>Armor</h6>
                                <div id="armorContainer" class="proficiency-grid">
                                    <!-- Armor will be populated dynamically -->
                                </div>
                            </div>

                            <!-- Weapons -->
                            <div class="proficiency-section">
                                <h6>Weapons</h6>
                                <div id="weaponsContainer" class="proficiency-grid">
                                    <!-- Weapons will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                        <div class="proficiency-notes-container mt-3" id="proficiencyNotes">
                            <!-- Proficiency notes will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feats -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Feats</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" id="addFeatBtn">
                                <i class="fas fa-plus"></i> Add Feat
                            </button>
                            <span class="text-muted">
                                <span id="featCount">0</span> / <span id="maxFeats">0</span> feats
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="feat-list" id="featList">
                            <!-- Feats will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Optional Features -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Optional Features</h5>
                        <button class="btn btn-primary btn-sm" id="addFeatureBtn">
                            <i class="fas fa-plus"></i> Add Feature
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="feature-list" id="featureList">
                            <!-- Optional features will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="equipmentPage">
        <div class="row">
            <!-- Starting Equipment -->
            <div class="col-12 mb-4" id="startingEquipmentSection" style="display: none;">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Starting Equipment</h5>
                    </div>
                    <div class="card-body">
                        <div class="starting-equipment-choices">
                            <!-- Starting equipment choices will be populated dynamically -->
                        </div>
                        <div class="starting-equipment-preview mt-3">
                            <!-- Preview of selected equipment will be shown here -->
                        </div>
                        <div class="d-flex justify-content-end mt-3">
                            <button class="btn btn-primary" id="confirmStartingEquipment">
                                Confirm Equipment
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Management -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Inventory</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary btn-sm" id="addItemBtn">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                            <span class="text-muted">
                                Weight: <span id="inventoryWeight">0</span> / <span id="weightCapacity">0</span> lbs
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="inventory-list" id="inventoryList">
                            <!-- Inventory items will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Packs -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Equipment Packs</h5>
                    </div>
                    <div class="card-body">
                        <div class="pack-list" id="packList">
                            <!-- Equipment packs will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Slots -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Equipped Items</h5>
                    </div>
                    <div class="card-body">
                        <div class="equipment-slots" id="equipmentSlots">
                            <!-- Equipment slots will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attuned Items -->
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Attuned Items</h5>
                        <span class="text-muted">
                            <span id="attunedCount">0</span> / <span id="attunementLimit">3</span> items
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="attuned-items" id="attunedItems">
                            <!-- Attuned items will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="detailsPage">
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Character Information</h5>
                    </div>
                    <div class="card-body character-info-card-body">
                        <div class="character-info-container">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Character Name</label>
                                    <input type="text" class="form-control" id="characterName">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Player Name</label>
                                    <input type="text" class="form-control" id="playerName">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Height</label>
                                    <input type="text" class="form-control" id="height">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Weight</label>
                                    <input type="text" class="form-control" id="weight">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Gender</label>
                                    <input type="text" class="form-control" id="gender">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header py-2">
                        <h5 class="mb-0">Background Story</h5>
                    </div>
                    <div class="card-body character-info-card-body">
                        <div class="character-info-container">
                            <div class="form-row" style="height: 100%;">
                                <div class="form-group">
                                    <textarea class="form-control" id="backstory"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="previewPage">
        <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Character Sheet Preview</h5>
            </div>
            <div class="card-body">
                <div class="pdf-preview" id="pdfPreview">
                    <!-- PDF preview will be shown here -->
                </div>
            </div>
        </div>
    </template>

    <template id="settingsPage">
        <div class="card">
            <div class="card-header py-2">
                <h5 class="mb-0">Settings</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label class="form-label">Character Save Location</label>
                    <div class="save-location-container mb-3" id="saveLocationDisplay">
                        <span id="currentSaveLocation">Loading...</span>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="chooseFolderBtn">
                            <i class="fas fa-folder-open"></i>
                            <span>Change Folder</span>
                        </button>
                        <button class="btn btn-secondary" id="resetFolderBtn" title="Reset to default location">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Add this new template before the closing body tag -->
    <template id="tooltipTestPage">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Tooltip Test Page</h5>
            </div>
            <div class="card-body">
                <div class="tooltip-test-content">
                    <h3>Items</h3>
                    <p>This is a {@item Thieves' Tools|PHB|p154} used by rogues.</p>

                    <h3>Spells</h3>
                    <p>The wizard cast {@spell light} to illuminate the dark cave.</p>
                    <p>The cleric prepared {@spell cure wounds} and {@spell bless} for the day.</p>

                    <h3>Classes</h3>
                    <p>The {@class Fighter} stood ready with their weapon.</p>
                    <p>A {@class Wizard} studied their spellbook intently.</p>

                    <h3>Races</h3>
                    <p>The {@race Dwarf} mined deep in the mountains.</p>
                    <p>A {@race Elf} moved silently through the forest.</p>

                    <h3>Actions</h3>
                    <p>The warrior used the {@action Dodge} action.</p>
                    <p>The rogue attempted to {@action Hide}.</p>

                    <h3>Conditions</h3>
                    <p>The monster became {@condition poisoned}.</p>
                    <p>The warrior was {@condition prone}.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- New Character Modal -->
    <div class="modal fade" id="newCharacterModal" tabindex="-1" aria-labelledby="newCharacterModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newCharacterModalLabel">Create New Character</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="newCharacterForm">
                        <div class="mb-3">
                            <label for="newCharacterName" class="form-label">Character Name</label>
                            <input type="text" class="form-control" id="newCharacterName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Source Books</label>
                            <div id="sourceBookSelection">
                                <!-- Source book toggles will be added here -->
                            </div>
                            <small class="text-muted">Core books are always included.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="createCharacterBtn">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Selection Modal -->
    <div class="modal fade" id="itemSelectionModal" tabindex="-1" aria-labelledby="itemSelectionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="itemSelectionModalLabel">Add Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="itemSearchInput" placeholder="Search items...">
                    </div>
                    <div class="item-list" id="itemSearchResults">
                        <!-- Search results will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pack Contents Modal -->
    <div class="modal fade" id="packContentsModal" tabindex="-1" aria-labelledby="packContentsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="packContentsModalLabel">Pack Contents</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="pack-contents-list">
                        <!-- Pack contents will be populated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="unpackBtn">Unpack</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Feat Selection Modal -->
    <div class="modal fade" id="featSelectionModal" tabindex="-1" aria-labelledby="featSelectionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="featSelectionModalLabel">Add Feat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="featSearchInput" placeholder="Search feats...">
                    </div>
                    <div class="feat-search-results" id="featSearchResults">
                        <!-- Search results will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Optional Feature Selection Modal -->
    <div class="modal fade" id="featureSelectionModal" tabindex="-1" aria-labelledby="featureSelectionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="featureSelectionModalLabel">Add Optional Feature</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="featureSearchInput"
                            placeholder="Search features...">
                    </div>
                    <div class="feature-search-results" id="featureSearchResults">
                        <!-- Search results will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Utils -->
    <script type="module" src="js/utils/DataLoader.js"></script>
    <script type="module" src="js/utils/TextProcessor.js"></script>
    <script type="module" src="js/utils/ReferenceResolver.js"></script>
    <script src="assets/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Managers -->
    <script type="module" src="js/managers/SourceManager.js"></script>
    <script type="module" src="js/managers/PrerequisiteManager.js"></script>
    <script type="module" src="js/managers/ProficiencyManager.js"></script>
    <script type="module" src="js/managers/MagicItemManager.js"></script>
    <script type="module" src="js/managers/PackManager.js"></script>
    <script type="module" src="js/managers/StartingEquipmentManager.js"></script>
    <script type="module" src="js/managers/EquipmentManager.js"></script>
    <script type="module" src="js/managers/CharacteristicManager.js"></script>
    <script type="module" src="js/managers/FeatManager.js"></script>
    <script type="module" src="js/managers/SpellManager.js"></script>
    <script type="module" src="js/managers/RaceManager.js"></script>
    <script type="module" src="js/managers/ClassManager.js"></script>
    <script type="module" src="js/managers/BackgroundManager.js"></script>
    <script type="module" src="js/managers/OptionalFeatureManager.js"></script>
    <script type="module" src="js/managers/InventoryManager.js"></script>
    <script type="module" src="js/managers/AttunementManager.js"></script>

    <!-- Main application modules -->
    <script type="module" src="js/utils/Initialize.js"></script>
    <script type="module" src="js/utils.js"></script>
</body>

</html>